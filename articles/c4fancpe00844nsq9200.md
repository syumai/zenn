---
title: "ãƒ•ãƒ©ã‚°ä»˜ãã®Go 1.17ã§Genericsã¯ã©ã“ã¾ã§å‹•ãã®ã‹"
emoji: "ï¸ğŸ„"
type: "tech"
topics: ["go", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°"]
published: false
---

æœ¬è¨˜äº‹ã¯[Go 1.17 ãƒªãƒªãƒ¼ã‚¹ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼](https://gocon.connpass.com/event/216361/)ã«ã¦ç™ºè¡¨ã—ãŸå†…å®¹ã‚’æ–‡æ›¸åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚

# Go 1.17ãƒªãƒªãƒ¼ã‚¹

2021å¹´8æœˆ16æ—¥ã€[Go 1.17](https://go.dev/blog/go1.17)ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚

Go 1.17ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«ã¯ã€Genericsã®é–¢é€£æ©Ÿèƒ½ã«ã¤ã„ã¦è¨˜è¼‰ã•ã‚Œã¦ãŠã‚‰ãšã€æ­£å¼ãªãƒªãƒªãƒ¼ã‚¹å†…å®¹ã¨ã—ã¦ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ãŸã ã€RCç‰ˆã§ã¯ãƒ•ãƒ©ã‚°ä»˜ãã§ä¸€éƒ¨Genericsã®æ©Ÿèƒ½ãŒä½¿ãˆã¦ã„ãŸã®ã§ã€ã“ã‚ŒãŒå‡ºæ¥ãªã„ã‹è©¦ã—ã¦ã¿ãŸã¨ã“ã‚ã€åŒæ§˜ã« **ãƒ•ãƒ©ã‚°ä»˜ãã®å®Ÿè¡Œã§GenericsãŒã‚ã‚‹ç¨‹åº¦å‹•ã** ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## ãƒ•ãƒ©ã‚°ä»˜ãã®å®Ÿè¡Œ

ãŠä½¿ã„ã®Go 1.17ã§ã€ ` -gcflags="-G=3"` ã®ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã¦å®Ÿè¡Œã‚’ã™ã‚‹ã“ã¨ã§å‹•ã‹ã›ã¾ã™ã€‚
ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ãŸã®ã§ã€ãœã²ã“ã‚Œã‚’ `main.go` ã¨ã—ã¦ä¿å­˜ã—ã¦å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚

`main.go`

```go
package main

type slice[T any] []T

func main() {}
```

```sh
go run -gcflags="-G=3" main.go
```

# ã©ã“ã¾ã§å‹•ãã®ã‹

å‹•ãã“ã¨ãŒç¢ºèªå‡ºæ¥ãŸã‚‰ã€æ¬¡ã¯ã©ã“ã¾ã§ä½¿ãˆã‚‹ã®ã‹ãŒæ°£ã«ãªã‚Šã¾ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¦ã€Genericsã®ä»•æ§˜ã§è¿½åŠ ã•ã‚Œã‚‹è¦ç´ ã”ã¨ã«å€‹åˆ¥ã«æ¤œè¨¼ã‚’è¡Œã„ã¾ã—ãŸã€‚

æ¤œè¨¼ã«ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦ [syumai/go117-generics-investigation](https://github.com/syumai/go117-generics-investigation) ã«é…ç½®ã—ã¦ã„ã‚‹ã®ã§ã€æ‰‹å…ƒã§è©¦ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚

## æ¤œè¨¼ã—ãŸã„ã‚‚ã®

æ¤œè¨¼ã—ãŸã„å†…å®¹ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

1. å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
   - å‹å®£è¨€
   - é–¢æ•°å®£è¨€
   - å‹æ¨è«–
2. Interface
   - äº‹å‰å®£è¨€ã•ã‚ŒãŸconstraints
     - any, comparable
   - type list (type sets proposalã§å»ƒæ­¢)
   - type sets
3. æ¨™æº–package
   - constraints
   - slices
   - maps

type listã¯ã€Go 1.17ãƒªãƒªãƒ¼ã‚¹æ™‚ç‚¹ã§æ—¢ã« [type sets](https://github.com/golang/go/issues/45346) ã«ã‚ˆã‚Šç½®ãæ›ãˆã‚‰ã‚Œã‚‹äº‹ãŒæ±ºå®šã—ã¦ã„ã¾ã—ãŸ (7/22ã«accepted) ãŒã€RCç‰ˆæ™‚ç‚¹ã§å‹•ã„ã¦ã„ãŸã®ã¯type listã®æ–¹ã ã£ãŸã®ã§ã€ä¸¡æ–¹æ¤œè¨¼ã‚’è¡Œã†ã“ã¨ã¨ã—ã¾ã—ãŸã€‚

## æ¤œè¨¼ã«ä½¿ã£ãŸGoã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

```
$ go version
go version go1.17.1 darwin/arm64
```

## æ³¨æ„

* ç°¡å˜ã«è©¦ã—ãŸã ã‘ã®å†…å®¹ãªã®ã§ã€æ­£ç¢ºã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
* å‹•ãã‹ã‚‰ã¨ã„ã£ã¦ã€æ¥­å‹™ã«ä½¿ã†ã¨ä»Šå¾Œã®ä»•æ§˜å¤‰æ›´ã§å‹•ã‹ãªããªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™

# æ¤œè¨¼

1. Interface
2. æ¨™æº–package
3. å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

ã®é †ã§æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

## Interface

### äº‹å‰å®£è¨€ã•ã‚ŒãŸconstraints

äº‹å‰å®£è¨€ã•ã‚ŒãŸconstraintsã® `any, comparable` ã¨è¨€ã†interfaceãŒã€é€šå¸¸ã® (å‹åˆ¶ç´„ä»¥å¤–ã®) å‹ã¨ã—ã¦å­˜åœ¨ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ãŒå‹åˆ¶ç´„ã¨ã—ã¦ä½¿ãˆã‚‹ã‹ã¯ã€åˆ¥é€”å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ–¹ã§æ¤œè¨¼ã—ã¾ã™ã€‚

#### interface-1-1: any

```go
package main

type (
	A any // ã‚ã‚Œã°é€šã‚‹
)

func main() {}
```

##### çµæœ

```sh
$ go run -gcflags="-G=3" interface-1-1.go
# command-line-arguments
./interface-1-1.go:4:4: undefined: any
```

**å¤±æ•—**

anyã¯é€šå¸¸ã®å‹ã¨ã—ã¦ã¯å­˜åœ¨ã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚

#### interface-1-2: comparable

```go
package main

type (
	A comparable // ã‚ã‚Œã°é€šã‚‹
)

func main() {}
```

##### çµæœ

```sh
$ go run -gcflags="-G=3" interface-1-2.go
# command-line-arguments
<unknown line number>: internal compiler error: failed to resolve type comparable interface{==()}

Please file a bug report including a short program that triggers the error.
https://golang.org/issue/new
```

**å¤±æ•—**

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚é€šå¸¸ã®å‹ã¨ã—ã¦comparableã‚’ä½¿ã†ã“ã¨ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã€ã¨è¨€ã†ã‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å´ã®å®Ÿè£…ãŒç„¡ã„ã‚ˆã†ã§ã™ã€‚

### type list

ç¶šã„ã¦ã€type list (type sets proposalã«ã‚ˆã£ã¦ç½®ãæ›ãˆã‚‰ã‚ŒãŸå¤ã„ä»•æ§˜) ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã®interfaceå®šç¾©å†…ã® `type ...` ã®éƒ¨åˆ†ãŒtype listã«ç›¸å½“ã—ã¾ã™ã€‚
ã“ã‚ŒãŒä½¿ãˆã‚‹ãªã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‹ã¯ãšã§ã™ï¼

```go
package main

type Signed interface {
  type int, int8, int16, int32, int64 // type list
}

func main() {}
```

#### çµæœ

```sh
$ go run -gcflags="-G=3" interface-2.go
```

**æˆåŠŸ**

ç‰¹ã«ã‚¨ãƒ©ãƒ¼ã‚‚ãªãå®Ÿè¡Œã«æˆåŠŸã—ã¾ã—ãŸï¼
type listã¯ä½¿ãˆã‚‹ã‚ˆã†ã§ã™ã€‚

### type set

ç¶šã„ã¦ã€type setã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

type setã§ã¯ã€interfaceå®šç¾©å†…ã® `type` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¶ˆãˆã¦ã€ä»£ã‚ã‚Šã«interface elementã¨å‘¼ã°ã‚Œã‚‹è¦ç´ ã‚’ä¸¦ã¹ã‚‹å½¢å¼ã«å¤‰ã‚ã‚Šã¾ã—ãŸã€‚
ã“ã‚ŒãŒä½¿ãˆã‚‹ãªã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‹ã¯ãšã§ã™ï¼

```go
package main

type Signed interface {
  ~int | ~int8 | ~int16 | ~int32 | ~int64 // type set
}

func main() {}
```

#### çµæœ

```sh
$ go run -gcflags="-G=3" interface-3.go
# command-line-arguments
./interface-3.go:4:2: ~int | ~int8 | ~int16 | ~int32 | ~int64 is not a type
./interface-3.go:4:3: int (type) is not an expression
./interface-3.go:4:10: int8 (type) is not an expression
./interface-3.go:4:18: int16 (type) is not an expression
./interface-3.go:4:27: int32 (type) is not an expression
./interface-3.go:4:36: int64 (type) is not an expression
```

**å¤±æ•—**

type setã®æ–‡æ³•ã¯å…¨ãã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚
Go 1.17ã§Genericsã‚’å‹•ã‹ã™ã«ã‚ãŸã£ã¦ã¯ã€type setã¯é¿ã‘ã¦type listã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã—ãŸã€‚

## æ¨™æº–package

ç¶šã„ã¦ã€æ¨™æº–packageãŒä½¿ãˆã‚‹ã‹ã©ã†ã‹æ¤œè¨¼ã—ã¾ã™ã€‚
Genericsã®å°å…¥ã«ã‚ãŸã£ã¦ã€å°‘ãªãã¨ã‚‚ä¸‹è¨˜ã®packageãŒå°å…¥ã•ã‚Œãã† (2021/9/25æ™‚ç‚¹ã§ã¯ProposalãŒacceptã•ã‚Œã¦ã„ã¾ã™) ãªã®ã§ã€ã“ã‚Œã‚‰ãŒä½¿ãˆã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã™ã€‚ 

- constraints
- slices
- maps

å­˜åœ¨ã™ã‚Œã°importå‡ºæ¥ã‚‹ã¯ãšãªã®ã§ã€ã¾ã¨ã‚ã¦æ¤œè¨¼ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

```go
package main

import (
        _ "constraints" // ã‚ã‚Œã°é€šã‚‹
        _ "maps"        // ã‚ã‚Œã°é€šã‚‹
        _ "slices"      // ã‚ã‚Œã°é€šã‚‹
)

func main() {}
```

### çµæœ

```sh
$ go run -gcflags="-G=3" packages.go
packages.go:4:2: package constraints is not in GOROOT (/opt/homebrew/Cellar/go/1.17.1/libexec/src/constraints)
packages.go:5:2: package maps is not in GOROOT (/opt/homebrew/Cellar/go/1.17.1/libexec/src/maps)
packages.go:6:2: package slices is not in GOROOT (/opt/homebrew/Cellar/go/1.17.1/libexec/src/slices)
```

**å¤±æ•—**

æ–°è¦ã®æ¨™æº–packageã¯ä¸€ã¤ã‚‚å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã—ãŸâ€¦ã€‚

## å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

æœ€å¾Œã«ã€å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã©ã“ã¾ã§ä½¿ãˆã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

### å‹å®£è¨€

ä¸‹è¨˜ã®å½¢å¼ã§ã€å‹å®£è¨€ã«å¯¾ã—ã¦å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆã‚’è¿½åŠ å‡ºæ¥ã‚‹ã‹æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚

```go
package main

type Slice[T interface{}] []T

func main() {}
```

#### çµæœ

```sh
$ go run -gcflags="-G=3" type-1-1.go
# command-line-arguments
<unknown line number>: internal compiler error: Cannot (yet) export a generic type: Slice

Please file a bug report including a short program that triggers the error.
https://golang.org/issue/new
```

**å¤±æ•—**

`generic type` ã‚’ `export` ã§ããªã„ã¨è¨€ã†ã‚¨ãƒ©ãƒ¼ã§ã—ãŸã€‚
ã¨è¨€ã†ã“ã¨ã¯exportã—ãªã‘ã‚Œã°ä½¿ãˆã‚‹â€¦ï¼Ÿ

### å‹å®£è¨€ (exportã—ãªã„)

å…ˆç¨‹ã® `Slice` type ã‚’ `slice` ã«ã—ã¦å‹•ãã‹è©¦ã—ã¾ã™ã€‚

```go
package main

type slice[T interface{}] []T

func main() {}
```

#### çµæœ

```sh
$ go run -gcflags="-G=3" type-1-2.go
```

**æˆåŠŸ**

exportã—ãªã‘ã‚Œã°å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã®å‹ã‚’å®£è¨€å‡ºæ¥ã‚‹ã‚ˆã†ã§ã™ã€‚

### å‹åˆ¶ç´„ (any, comparable)

å…ˆã»ã©ã€å‹ã¨ã—ã¦ã¯ä½¿ãˆãªã‹ã£ãŸanyã¨comparableãŒå‹åˆ¶ç´„ã¨ã—ã¦ã¯ä½¿ãˆã‚‹ã®ã‹è©¦ã—ã¾ã™ã€‚

```go
package main

type anySlice[T any] []T // constraintã¨ã—ã¦anyãŒä½¿ãˆã‚‹ã‹ç¢ºèª
type comparableSlice[T comparable] []T // constraintã¨ã—ã¦anyãŒä½¿ãˆã‚‹ã‹ç¢ºèª

func main() {}
```

#### çµæœ


```sh
$ go run -gcflags="-G=3" type-1-3.go
```

**æˆåŠŸ**

é€šå¸¸ã®å‹ã¨ã—ã¦ã¯ä½¿ãˆãªã„ã‚‚ã®ã®ã€å‹åˆ¶ç´„ã®æ–‡è„ˆã§ã¯å•é¡Œãªãä½¿ãˆã‚‹ã‚ˆã†ã§ã™ã€‚

### é–¢æ•°å®£è¨€

ä¸‹è¨˜ã®PrintSignedã®ã‚ˆã†ãªå½¢å¼ã§ã€é–¢æ•°å®£è¨€ã«å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã‹è©¦ã—ã¾ã™ã€‚

```go
package main

import "fmt"

type Signed interface {
	type int, int8, int16, int32, int64 // type list
}

func PrintSigned[T Signed](i T) {
	fmt.Println(i)
}

func main() {
	PrintSigned[int](1)
}
```

#### çµæœ

```sh
$ go run -gcflags="-G=3" type-2-1.go
# command-line-arguments
./type-2-1.go:9:6: internal compiler error: Cannot export a generic function (yet): PrintSigned

Please file a bug report including a short program that triggers the error.
https://golang.org/issue/new
```

**å¤±æ•—**

`generic function` ã‚’ `export` ã§ããªã„ã¨è¨€ã†ã‚¨ãƒ©ãƒ¼ã§ã—ãŸã€‚
å‹åŒæ§˜ã€exportã—ãªã‘ã‚Œã°ä½¿ãˆã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### é–¢æ•°å®£è¨€ (exportã—ãªã„)


- é–¢æ•°å®£è¨€
- å‹æ¨è«–
  - Function type inference
  - Constraint type inference


# çµæœ


## ä»•æ§˜ã¨ã—ã¦ã¯å¤ã„ã‚‚ã®ã®ã€ãã‚Œãªã‚Šã«å‹•ã„ãŸ


# ãŠã¾ã‘


## Genericsã®é–‹ç™ºbranchã®å†…å®¹ãŒmasterã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰ã—ã„


ã“ã‚Œã§æœ€æ–°ã®masterã®å®Ÿè£…å†…å®¹ãŒå‹•ãã¾ã™

```sh
go install golang.org/dl/gotip@latest
gotip download # masterã‚’downloadã—ã¦ãã‚Œã‚‹
GOEXPERIMENT=unified gotip run main.go
```

`GOEXPERIMENT=unified` ã¯zcheeã•ã‚“ã«æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸtenntennã•ã‚“ã«æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸ


## æœ€æ–°ã®masterã§ã¯type setã‚‚å‹•ãã¾ã—ãŸï¼


