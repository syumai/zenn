---
title: "フラグ付きのGo 1.17でGenericsはどこまで動くのか"
emoji: "️🍄"
type: "tech"
topics: ["go", "プログラミング"]
published: false
---

本記事は[Go 1.17 リリースパーティー](https://gocon.connpass.com/event/216361/)にて発表した内容を文書化したものです。

# Go 1.17リリース

2021年8月16日、[Go 1.17](https://go.dev/blog/go1.17)がリリースされました。

Go 1.17のリリースノートには、Genericsの関連機能について記載されておらず、正式なリリース内容としては含まれていませんでした。
ただ、RC版ではフラグ付きで一部Genericsの機能が使えていたので、これが出来ないか試してみたところ、同様に **フラグ付きの実行でGenericsがある程度動く** ことが確認できました。

## フラグ付きの実行

お使いのGo 1.17で、 ` -gcflags="-G=3"` のフラグを付けて実行をすることで動かせます。
簡単なサンプルコードを用意したので、ぜひこれを `main.go` として保存して実行してみてください。

`main.go`

```go
package main

type slice[T any] []T

func main() {}
```

```sh
go run -gcflags="-G=3" main.go
```

# どこまで動くのか

動くことが確認出来たら、次はどこまで使えるのかが氣になります。
サンプルコードを用意して、Genericsの仕様で追加される要素ごとに個別に検証を行いました。

検証に使ったコードは全て [syumai/go117-generics-investigation](https://github.com/syumai/go117-generics-investigation) に配置しているので、手元で試したい方はこちらをご利用ください。

## 検証したいもの

検証したい内容は下記の通りです。

1. Type Parameters
   - 型宣言
   - 関数宣言
   - 型推論
2. Interface
   - 事前宣言されたconstraints
     - any, comparable
   - type list (type sets proposalで廃止)
   - type sets
3. 標準package
   - constraints
   - slices
   - maps

type listは、Go 1.17リリース時点で既に [type sets](https://github.com/golang/go/issues/45346) により置き換えられる事が決定していました (7/22にaccepted) が、RC版時点で動いていたのはtype listの方だったので、両方検証を行うこととしました。

## 注意

* 簡単に試しただけの内容なので、正確でない可能性があります
* 動くからといって、業務に使うと今後の仕様変更で動かなくなる可能性が高いです

# 検証

1. Interface
2. 標準package
3. Type Parameters

の順で検証を行います。

## Interface

### 事前宣言されたconstraints

事前宣言されたconstraintsの `any, comparable` と言うinterfaceが、型として存在しているか確認します。

```go
package main

type (
	A any        // あれば通る
	B comparable // あれば通る
)

func main() {}
```

#### 結果


```sh
$ go run -gcflags="-G=3" interface-1.go
# command-line-arguments
./interface-1.go:4:4: undefined: any
./interface-1.go:5:4: undefined: comparable
```

型としては存在していないようでした。

### type list

続いて、type sets proposalによって置き換えられたtype listを検証します。

### type set


## 標準package

  - constraints
  - slices
  - maps


## Type Parameters

  - 型宣言
  - 関数宣言
  - 型推論
    - Function type inference
    - Constraint type inference


# 結果


## 仕様としては古いものの、それなりに動いた


# おまけ


## Genericsの開発branchの内容がmasterにマージされたらしい


これで最新のmasterの実装内容が動きます

```sh
go install golang.org/dl/gotip@latest
gotip download # masterをdownloadしてくれる
GOEXPERIMENT=unified gotip run main.go
```

`GOEXPERIMENT=unified` はzcheeさんに教えてもらったtenntennさんに教えてもらいました


## 最新のmasterではtype setも動きました！


