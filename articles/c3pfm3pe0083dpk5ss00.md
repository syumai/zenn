---
title: "Goã®deferæ–‡ã¨åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çµ„ã¿åˆã‚ã›ãŸæ™‚ã®æŒ™å‹•ã‚’ç†è§£ã™ã‚‹"
emoji: "ğŸŒŠ"
type: "tech"
topics: ["go", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è¨€èªä»•æ§˜"]
published: true
---
è»½ã„æ°—æŒã¡ã§Twitterã«æŠ•ä¸‹ã—ãŸã‚¯ã‚¤ã‚ºã«æ€ã£ãŸä»¥ä¸Šã«åéŸ¿ãŒã‚ã£ãŸã®ã§ã€è§£èª¬è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

# ã‚¯ã‚¤ã‚ºã«ã¤ã„ã¦

[æŠ•ä¸‹ã—ãŸã‚¯ã‚¤ã‚º](https://twitter.com/__syumai/status/1415309048686149639?s=20)ã¯æ¬¡ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚

```go
func main() {
  println(f())
}

func f() (a, b int) {
  defer func() {
    a += 1
    b += 1
  }()
  return 2, 3
}
```

ã“ã®æ™‚ã®å‡ºåŠ›çµæœã‚’å•ã†å•é¡Œã§ã€é¸æŠè‚¢ã¯ä¸‹è¨˜ã®4ã¤ã§ã™ã€‚

1. `0 0`
2. `1 1`
3. `2 3`
4. `3 4`

## å•é¡Œã®ãƒã‚¤ãƒ³ãƒˆ

ã“ã®ã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ã‚’çŸ¥ã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆã¯ä¸‹è¨˜ã®3ã¤ã§ã™ã€‚

1. é–¢æ•°ã¯ä½•ã‚’è¿”ã—ã¦ã„ã‚‹ã®ã‹
1. return æ–‡ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹
1. defer æ–‡ã§é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

ã¾ãšã€é–¢æ•°å®£è¨€ã®æ§‹æ–‡ã®ãŠã•ã‚‰ã„ã‚’è¡Œã£ã¦ã€ãã®å¾Œè§£èª¬ã«é€²ã¿ã¾ã™ã€‚

# ãŠã•ã‚‰ã„

ä¸‹è¨˜ã«ã€ä»Šå›ã®å†…å®¹ã«é–¢ä¿‚ã™ã‚‹éƒ¨åˆ†ã®EBNFã‚’æŠœç²‹[^1]ã—ãŸã‚‚ã®ã‚’ç¤ºã—ã¾ã™ã€‚

```
FunctionDecl (é–¢æ•°å®£è¨€) = "func" FunctionName Signature [ FunctionBody ] .
Signature (ã‚·ã‚°ãƒ‹ãƒãƒ£) = Parameters [ Result ] .
Result (çµæœ) = Parameters | Type .
Parameters (ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿) = "(" [ ParameterList [ "," ] ] ")" .
```

[^1]: å¼•ç”¨å…ƒ: [Function declarations](https://golang.org/ref/spec#Function_declarations), [Function types](https://golang.org/ref/spec#Function_types)

é›‘ãªå›³ã§æç¸®ã§ã™ãŒã€é–¢æ•°å®£è¨€ã®ã‚³ãƒ¼ãƒ‰ã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ï¼ˆå³å¯†ãªã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/17c73ca68cc574f7cef21962.png)

ä»Šå›ã®è¨˜äº‹ã§é‡è¦ãªã®ã¯ä¸‹è¨˜ã®é …ç›®ã§ã™ã€‚

* **çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (result parameters)**
  - é–¢æ•° / ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸçµæœã¨ã—ã¦å‘¼ã³å‡ºã—å…ƒã«è¿”ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã“ã¨ã€‚ä¸Šè¨˜å›³ä¸­ã§ã® `(b int)` ã«å¯¾å¿œã™ã‚‹ã€‚
    - é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (ä¸Šè¨˜å›³ä¸­ã§ã® `(a int)`) ã¨ã¯åŒºåˆ¥ã•ã‚Œã‚‹ã€‚
* **åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (named result parameters)**
  - çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã€åå‰ã‚’ä»˜ä¸ã—ãŸã‚‚ã®ã€‚
    - çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯åå‰ç„¡ã—ã§ `(b int)` ã§ã¯ãªã `int` ã¨ã ã‘æ›¸ãã“ã¨ãŒå‡ºæ¥ã‚‹[^2]ã€‚

æœ¬è¨˜äº‹ä¸­ã§ã®å‘¼ç§°ã‚‚ä¸Šè¨˜ã®é€šã‚Šã¨ãªã‚Šã¾ã™ã€‚

[^2]: çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã¯ã€ã©ã¡ã‚‰ã‹ã¨è¨€ã†ã¨åå‰ç„¡ã—ã®æ–¹ãŒä½¿ç”¨é »åº¦ã¯é«˜ã„ã€‚

# ãƒã‚¤ãƒ³ãƒˆã®è§£èª¬

å…ˆã»ã©æŒ™ã’ãŸã€

1. é–¢æ•°ã¯ä½•ã‚’è¿”ã—ã¦ã„ã‚‹ã®ã‹
1. return æ–‡ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹
1. defer æ–‡ã§é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

ã«ã¤ã„ã¦è§£èª¬ã‚’è¡Œã„ã¾ã™ã€‚

## 1. é–¢æ•°ã¯ä½•ã‚’è¿”ã—ã¦ã„ã‚‹ã®ã‹

é–¢æ•°ã¯ã€**é–¢æ•°ã®å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã—ã¾ã™**ã€‚
ã“ã‚Œã¯ã€Goã®è¨€èªä»•æ§˜ã® [`Calls`](https://golang.org/ref/spec#Calls)[^3] ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

[^3]: `Calls` ã¯ã€`å¼` ã®ä¸€ã¤ã€‚é–¢æ•°ã¾ãŸã¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸæ™‚ã«å¾—ã‚‰ã‚Œã‚‹å€¤ã«ã¤ã„ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹

> The return parameters of the function are passed by value back to the caller when the function returns.

ã–ã£ãã‚Šè¨³ã™ã¨ã€ *é–¢æ•°ãŒè¿”ã‚‹ã¨ãã€é–¢æ•°ã®æˆ»ã‚Šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå‘¼ã³å‡ºã—å…ƒã«å€¤ã§æ¸¡ã•ã‚Œã‚‹* ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚(ä»•æ§˜ã®ã“ã®ç®‡æ‰€ã§ã®ã¿ `return parameters` ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ `result parameters` ã®äº‹ã‚’æŒ‡ã—ã¦ã„ã‚‹ã¨è€ƒãˆã¦å•é¡Œç„¡ã„ã§ã—ã‚‡ã†ã€‚)

æ¬¡ã«ã€`é–¢æ•°ã®å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã™`ã¨è¨€ã£ãŸæ™‚ã®ã€**çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤**ã¨ã¯ä½•ã‹ã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ãªé–¢æ•°å®£è¨€ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚
```go
func F(a int) (b int) {
  ...
}
```

ã“ã®æ™‚ã€åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã® `b` ã¯æ¬¡ã®ã‚ˆã†ã«ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
```go
func F(a int) (b int) {
  b = 10
  return
}
```

ã“ã®ã‚ˆã†ã«ã€åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€é–¢æ•°å†…ã§é€šå¸¸ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨åŒã˜ã‚ˆã†ã«æ‰±ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™[^4]ã€‚
ã“ã“ã‹ã‚‰ã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã¨ã¯ã€**é–¢æ•°å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§ã€åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤**ã®ã“ã¨ã‚’æŒ‡ã™ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ä¸Šè¨˜ã®ä¾‹ã§è¨€ã†ã¨ã€é–¢æ•°å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§å¤‰æ•° `b` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã¯ `10` ãªã®ã§ã€é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã¯ `10` ã¨ãªã‚Šã¾ã™ã€‚

[^4]: ä»•æ§˜ã§ã¯ã€ *The result parameters act as ordinary local variables and the function may assign values to them as necessary.* ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

## 2. return æ–‡ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹

return æ–‡ã«ã¯ã„ãã¤ã‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€é‡è¦ãªæ©Ÿèƒ½ã¨ã—ã¦**çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã®å€¤ã®è¨­å®š**[^5]ãŒã‚ã‚Šã¾ã™ã€‚

[^5]: ä»•æ§˜ã§ã¯ã€ *A "return" statement that specifies results sets the result parameters ...* ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ä¾‹1) å˜ä¸€ã®å€¤ã®è¿”å´

```go
func F() (i int) {
  return 100
}
```

ã“ã®æ™‚ã€ `return 100` ã¯ã€åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•° `i` ã«å¯¾ã—ã¦ `100` ã‚’è¨­å®šã—ã¾ã™ã€‚
é–¢æ•°ã¯ã€å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã™ã®ã§ã€ `100` ã‚’è¿”ã—ã¾ã™ã€‚

### ä¾‹2) è¤‡æ•°ã®å€¤ã®è¿”å´

```go
func F() (i int, err error) {
  e := fmt.Errorf("error")
  return 200, e
}
```

ã“ã®æ™‚ã€ `return 200, e` ã¯ã€åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•° `i` ã«å¯¾ã—ã¦ `200` ã‚’ã€ `err` ã«å¯¾ã—ã¦ `e`ã‚’è¨­å®šã—ã¾ã™ã€‚
é–¢æ•°ã¯ã€å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã™ã®ã§ã€ `200` , `e` ã®2ã¤ã‚’è¿”ã—ã¾ã™ã€‚

ä¸Šè¨˜ã®ä¾‹ã‹ã‚‰ã€**return æ–‡ã¯çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã¸ã®ä»£å…¥ã‚’è¡Œã†æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹**ã¨è€ƒãˆã‚‹ã¨ç†è§£ã—ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

return æ–‡ã¯ã€é–¢æ•°ã‚’çµ‚äº†ã•ã›ã‚‹æ©Ÿèƒ½ã‚‚æŒã¤ã®ã§ã€if æ–‡ãªã©ã§åˆ†å²ã—ã¦è¤‡æ•°ã®return æ–‡ã‚’æ›¸ã„ãŸå ´åˆã¯ã€å®Ÿè¡Œã•ã‚ŒãŸreturn æ–‡ã«ã‚ˆã£ã¦ã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã¸ä»£å…¥ã•ã‚Œã‚‹å€¤ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

:::details åå‰ç„¡ã—çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨return æ–‡ã‚’ä¸€ç·’ã«ä½¿ã£ãŸå ´åˆã«ã¤ã„ã¦ã®è£œè¶³
å®Ÿã¯ã€åå‰ã®ç„¡ã„é€šå¸¸ã®çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã‚‚ã€åŒç­‰ã®ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã“ã‚Œã¯ã€[DQNEOã•ã‚“ãŒ Gophers Slack ã«æ›¸ã„ã¦ã„ãŸå†…å®¹](https://gophers.slack.com/archives/C0178L0C5EU/p1626268859229200)ã§ã™ãŒã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åå‰ãŒç„¡ã‹ã£ãŸå ´åˆã€ **return æ–‡ã¯åå‰ã®ç„¡ã„è¦‹ãˆãªã„å¤‰æ•°ã¸ã®ä»£å…¥ã‚’è¡Œã†** ã¨è¨€ã†è€ƒãˆæ–¹ãŒã‚ã‚Šã¾ã™ã€‚
ä¾‹ã¨ã—ã¦ã€

```go
func f() (int) {
   return 1
}
```

ã¯ã€

```go
func f() (_r0 int) {
   return 1
}
```

ã¨è¨€ã£ãŸå½¢ã«å†…éƒ¨çš„ã«å¤‰æ›ã•ã‚Œã€return æ–‡ã¯çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•° `_r0` ã«å€¤ã‚’è¨­å®šã™ã‚‹ã¨è¨€ã†è€ƒãˆæ–¹ã§ã™ã€‚

å®Ÿéš›ã«ã€ã“ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã‚‹Goè¨€èªå‡¦ç†ç³»ã‚‚å­˜åœ¨ã—ã¦ã„ã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚
:::

## 3. defer æ–‡ã§é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

defer æ–‡ã§é…å»¶ã•ã‚ŒãŸé–¢æ•°ã¯ã€**return æ–‡ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€é–¢æ•°ãŒå‘¼ã³å‡ºã—å…ƒã«å€¤ã‚’è¿”ã™å‰**ã«å®Ÿè¡Œã•ã‚Œã¾ã™[^6]ã€‚
ã—ãŸãŒã£ã¦ã€defer æ–‡ã«ã‚ˆã£ã¦é…å»¶ã•ã‚ŒãŸé–¢æ•°ã¯ **return æ–‡ãŒçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•°ã«è¨­å®šã—ãŸå€¤ã‚’ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™**ã€‚

[^6]: ä»•æ§˜ã«ã¯ã€ *if the surrounding function returns through an explicit return statement, deferred functions are executed after any result parameters are set by that return statement but before the function returns to its caller.* ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æŒ™ã’ã¾ã™ã€‚

```go
func F() (i int) {
  defer func() {
    fmt.Println(i * 2)
  }()
  return 100
}
```

ã“ã®ã‚ˆã†ãªå ´åˆã€`defer func(){ ... }()` ã®å‘¼ã³å‡ºã—[^7]ã¯ã€return æ–‡ãŒçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ•° `i` ã«å€¤ã‚’è¨­å®šã—ãŸå¾Œã«è¡Œã‚ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€å‡ºåŠ›çµæœã¯ `100 * 2` ã§ `200` ã¨ãªã‚Šã¾ã™ã€‚

[^7]: å³å¯†ã«ã¯ã€ `defer æ–‡ã«ã‚ˆã£ã¦é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å‘¼ã³å‡ºã—` ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã«è¡¨è¨˜ã‚’ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚

ã•ã‚‰ã«ã€ã‚‚ã†ä¸€ã¤ç‰¹ç­†ã™ã¹ãäº‹é …ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã“ã¾ã§èª¬æ˜ã—ãŸå†…å®¹ã«ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚

* çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€é–¢æ•°å†…ã§ã¯é€šå¸¸ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨åŒã˜ã‚ˆã†ã«æ‰±ã†ã“ã¨ãŒã§ãã‚‹
* é–¢æ•°ã¯ã€é–¢æ•°ã®å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã™

ã“ã‚Œã‚‰ã¨ã€defer æ–‡ã«ã‚ˆã£ã¦é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ *return æ–‡ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€é–¢æ•°ãŒå‘¼ã³å‡ºã—å…ƒã«å€¤ã‚’è¿”ã™å‰* ã¨ãªã‚‹ä»•æ§˜ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€ **defer æ–‡ã¯ã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚ŒãŸå€¤ã‚’å¤‰æ›´ã—ã¦ã€é–¢æ•°ã®è¿”ã™å€¤ã‚’æ“ä½œã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹** ã¨è¨€ãˆã¾ã™ã€‚

```go
func F() (i int) {
  defer func() {
    i = i + 200
  }()
  return 100
}
```

ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸæ™‚ã€`defer func(){ ... }()` ã®å‘¼ã³å‡ºã—æ™‚ç‚¹ã§ã¯ã€ `i` ã« `100` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ `i = i + 200` ã¯ã€ `i` ã« `300` ã‚’è¨­å®šã—ã¾ã™ã€‚
ã“ã®çµæœã€é–¢æ•°ãŒè¿”ã™å€¤ã¯ `300` ã¨ãªã‚Šã¾ã™ã€‚

ã“ã“ã¾ã§ã§ã€ä»Šå›ã®å•é¡Œã‚’è§£ããŸã‚ã«å¿…è¦ãªæ€§è³ªã¯å…¨ã¦èª¬æ˜ã§ãã¾ã—ãŸï¼

# å•é¡Œã®è§£èª¬

ã§ã¯ã€å•é¡Œã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
func main() {
  println(f())
}

func f() (a, b int) {
  defer func() {
    a += 1
    b += 1
  }()
  return 2, 3
}
```

ã“ã“ã¾ã§èª¬æ˜ã—ãŸæ€§è³ªã‹ã‚‰ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã‚ã‹ã‚Šã¾ã™ã€‚

1. `return 2, 3` ãŒ `a, b` ã®ãã‚Œãã‚Œã«å€¤ã‚’è¨­å®šã™ã‚‹
   - `a` ã¯ `2`ã€ `b` ã¯ `3` ã¨ãªã‚‹
2. `defer func(){...}()` ãŒå‘¼ã³å‡ºã•ã‚Œã€ `a, b` ã®ãã‚Œãã‚Œã« `1` ãšã¤è¶³ã™
   - `a` ã¯ `3`ã€ `b` ã¯ `4` ã¨ãªã‚‹
3. é–¢æ•°ã®å®Ÿè¡ŒãŒçµ‚äº†ã—ã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚ŒãŸå€¤ã‚’è¿”ã™
   - `a, b` ã«è¨­å®šã•ã‚ŒãŸ `3, 4` ã‚’è¿”ã™
   
ã‚ˆã£ã¦ã€ç­”ãˆã¯ `4` ç•ªã® `3 4` ã§ã—ãŸï¼

# ã¾ã¨ã‚

æœ€å¾Œã«ã€ä»Šå›èª¬æ˜ã—ãŸãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã™ã€‚

1. **é–¢æ•°ã¯ä½•ã‚’è¿”ã—ã¦ã„ã‚‹ã®ã‹**
   - é–¢æ•°å®Ÿè¡Œçµ‚äº†æ™‚ç‚¹ã§ã€çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¿”ã™
1. **return æ–‡ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹**
   - çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å€¤ã‚’è¨­å®šã—ã¦ã„ã‚‹
1. **defer æ–‡ã§é…å»¶ã•ã‚ŒãŸé–¢æ•°ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**
   - return æ–‡ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€é–¢æ•°ãŒå‘¼ã³å‡ºã—å…ƒã«å€¤ã‚’è¿”ã™å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹
     - çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ã‚’æ“ä½œã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã‚‹

ä»¥ä¸Šã€defer æ–‡ã¨åå‰ä»˜ãçµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çµ„ã¿åˆã‚ã›ã®æŒ™å‹•ã«è¿·ã£ãŸå ´åˆã¯ã€ãœã²æœ¬è¨˜äº‹ã‚’æ€ã„å‡ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# è£œè¶³

## ä»Šå›ã®æ€§è³ªã‚’ä½¿ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚¨ãƒ©ãƒ¼ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒªãƒ³ã‚°

ä»Šå›èª¬æ˜ã—ãŸæ€§è³ªã‚’ä½¿ã†ã¨ã€ **é–¢æ•°ãŒè¿”ã™ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹** ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚

```go
// a ãŒ b ã‚ˆã‚Šå°ã•ã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚ãã†ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€€
func Less(a, b int) (err error) {
  if a > b {
    return fmt.Errorf("a must not be greater than b") // return æ–‡ A
  }
  if a == b {
    return fmt.Errorf("a and b must not be equal") // return æ–‡ B
  }
  return nil
}
```

ã“ã®æ™‚ã€æ¬¡ã®ã‚ˆã†ãªdefer æ–‡ã‚’æ›¸ã‘ã°ã€`return æ–‡ A`ã¨`return æ–‡ B`ã®ã©ã¡ã‚‰ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸãŒè¨˜éŒ²ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```go
func Less(a, b int) (err error) {
  defer func() {
    // a ãŒ bã‚ˆã‚Šå°ã•ããªã‹ã£ãŸå ´åˆã€ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã‚‹
    log.Printf("error happened in Less: %v", err)
  }()
  if a > b {
    return fmt.Errorf("a must not be greater than b")
  }
  if a == b {
    return fmt.Errorf("a and b must not be equal")
  }
  return nil
}
```

å®Ÿç”¨çš„ãªä¾‹ã‚’æŒ™ã’ã‚‰ã‚Œãšæç¸®ã§ã™ãŒã€ã“ã®ã‚ˆã†ãªä½¿ã„æ–¹ãŒã‚ã‚‹ã¨è¦šãˆã¦ãŠãã¨ä¾¿åˆ©ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### panicã«æ¸¡ã•ã‚ŒãŸå€¤ã‚’recoverã§å–å¾—ã—ã¦çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹

ã“ã‚Œã¯tenntennã•ã‚“ãŒTwitterã«æ›¸ã‹ã‚Œã¦ã„ãŸã‚‚ã®ã§ã€éå¸¸ã«å®Ÿç”¨çš„ã§ã™ã€‚èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ä¸‹è¨˜Tweetã‹ã‚‰è³‡æ–™ã‚’ã”è¦§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://twitter.com/tenntenn/status/1416941261328588801?s=20
